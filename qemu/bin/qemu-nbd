#!/bin/bash
# vi: et sts=4 sw=4 ts=4

# qemu-nbd wrapper that makes sure you set some basic performance-improving
# options

# Copyright (C) 2020-2022 Dan Church.
# License GPLv3: GNU GPL version 3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
# with Commons Clause 1.0 (https://commonsclause.com/).
# This is free software: you are free to change and redistribute it.
# There is NO WARRANTY, to the extent permitted by law.
# You may NOT use this software for commercial purposes.

ask_yn() (
    PROMPT=$1
    DEFAULT=$2
    read -r -p "$PROMPT [$([[ $DEFAULT = 'y' ]] && echo 'Y/n' || echo 'y/N')]? " ANSWER
    [[ $ANSWER =~ [01NYny] ]] || ANSWER=$DEFAULT
    # return
    [[ $ANSWER =~ [1Yy] ]]
)

# if STDIN is a tty, ask to use sane options
# If you use default options, reads and writes will be S-L-O-W.
EXTRA_ARGS=()
if [[ -t 1 ]]; then
    _SANE_CACHE=0
    _SANE_DISCARD=0
    _CONNECTING=0
    for ARG; do
        if [[ $ARG = -c ]]; then
            _CONNECTING=1
        elif [[ $ARG = --cache=unsafe ]]; then
            _SANE_CACHE=1
        elif [[ $ARG = --discard=unmap ]]; then
            _SANE_DISCARD=1
        fi
    done
    if [[ $_CONNECTING -ne 0 ]]; then
        if [[ $_SANE_CACHE -eq 0 || $_SANE_DISCARD -eq 0 ]]; then
            echo "Warning: You are about to create an NBD that will be extremely slow!" >&2
        fi
        if [[ $_SANE_CACHE -eq 0 ]]; then
            if ask_yn "Add --cache=unsafe to arguments" y; then
                EXTRA_ARGS+=('--cache=unsafe')
            fi
        fi
        if [[ $_SANE_DISCARD -eq 0 ]]; then
            if ask_yn "Add --discard=unmap to arguments" y; then
                EXTRA_ARGS+=('--discard=unmap')
            fi
        fi
    fi
fi

next_bin() (
    # Find path to wrapped program
    BINNAME=${0##*/}
    while read -r BIN; do
        if [[ ! $BIN -ef $0 ]]; then
            printf '%s\n' \
                "$BIN"
            return 0
        fi
    done < <(type -aP -- "$BINNAME")
    printf 'Wrapped program not found in PATH: %s\n' \
        "$BINNAME" \
        >&2
    return 127
)

REALBIN=$(next_bin) || exit

if [[ ${#EXTRA_ARGS[@]} -gt 0 ]]; then
    # Show you what I'm doing
    set -x
    exec "$REALBIN" \
        "${EXTRA_ARGS[@]}" \
        "$@"
else
    exec "$REALBIN" \
        "$@"
fi
