#!/bin/bash
# vi: et sts=4 sw=4 ts=4
set -e

_COMPOSER=${_COMPOSER:-composer}
TEMP_DIR=

setup-temp() {
    if [[ -z $TEMP_DIR ]]; then
        TEMP_DIR=$(mktemp -d -t "${0##*/}.XXXXXX")
        cleanup() {
            rm -fr -- "$TEMP_DIR"
        }
        trap 'cleanup' EXIT
    fi
}

# Work around a shortcoming in versions of composer (including current ones
# [2.2.13]) whereby a clone of a git-based dependency would fail because of a
# hard-coded 'origin' string.
setup-git-workaround() {
   setup-temp
   local -r \
       GIT_BIN=$(type -p git) \
       OLDPATH=$PATH
   cat <<EOF >"$TEMP_DIR/git"
#!/bin/sh
PATH=${OLDPATH@Q}
exec ${GIT_BIN@Q} \
    -c clone.defaultRemoteName=origin \
    "\$@"
EOF
    chmod +x -- "$TEMP_DIR/git"
    PATH=$TEMP_DIR:$PATH
}

pushd . >/dev/null

# XXX Can't use 'exec' from here on out, as it'll delete our git workaround
# before it executes.
setup-git-workaround

while [[ $PWD != / ]]; do
    if [[ -e composer.json ]]; then
        "$_COMPOSER" \
            "$@"
        exit
    fi
    cd ..
done

popd >/dev/null

printf 'Warning: Failed to find composer.json\n' \
    >&2

"$_COMPOSER" \
    "$@"
