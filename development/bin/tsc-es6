#!/bin/bash
# vi: et sts=4 sw=4 ts=4

# Script first conceived 2019-05-07

USAGE() {
    printf 'Usage: %s [OPTIONS] [--] FILE...\n' \
        "${0##*/}"
}

HELP_MESSAGE() {
    USAGE
    cat <<EOF
Wrapper for tsc to enable ES6 compilation.

  -h,--help     Show this help message.
  --strict      Turn on strict mode (default).
  --no-strict   Turn off strict mode.
  --            Terminate options list.

Copyright (C) 2019-2022 Dan Church.
License GPLv3+: GNU GPL version 3 or later (http://gnu.org/licenses/gpl.html).
This is free software: you are free to change and redistribute it. There is NO
WARRANTY, to the extent permitted by law.
EOF
}

STRICT=1

PASS_ARGS=()
NO_MORE_FLAGS=0
for ARG; do
    # Assume arguments that don't begin with a - are supposed to be files or other operands
    if [[ $NO_MORE_FLAGS -eq 0 && $ARG = -* ]]; then
        case "$ARG" in
            --strict)
                STRICT=1
                ;;
            --no-strict)
                STRICT=0
                ;;
            --help|-h)
                HELP_MESSAGE
                exit 0
                ;;
            --)
                NO_MORE_FLAGS=1
                ;;
            *)
                PASS_ARGS+=("$ARG")
                ;;
        esac
    else
        PASS_ARGS+=("$ARG")
    fi
done

if type tsc &>/dev/null; then
    TSC=(tsc)
else
    TSC=(npx tsc)
fi

TSC_ARGS=(
    --target es6
    --lib 'es6,dom'
)

if [[ $STRICT -ne 0 ]]; then
    TSC_ARGS+=(
        --alwaysStrict
        --noImplicitAny
        --noImplicitThis
        --strict
        --strictBindCallApply
        --strictFunctionTypes
        --strictPropertyInitialization
    )
fi

exec \
    "${TSC[@]}" \
    "${TSC_ARGS[@]}" \
    "${PASS_ARGS[@]}"
