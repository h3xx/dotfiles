#!/bin/bash
# vi: et sts=4 sw=4 ts=4

escape_vimcmd() {
    # Pipe breaks commands, must escape
    printf '%s\n' "${1//'|'/'\|'}"
}

smartquote() {
    local ARG=$1
    if [[ $ARG = *[^:@,./%^_=+a-zA-Z0-9-]* ]]; then
        ARG=\'${ARG//\'/\'\\\'\'}\'
    fi
    printf '%s\n' "$ARG"
}

GREP_PROG=
ARGS=()
NO_MORE_FLAGS=0
for ARG; do
    # Assume arguments that don't begin with a - are supposed to be files or other operands
    if [[ $NO_MORE_FLAGS -eq 0 && $ARG = -* ]]; then
        case "$ARG" in
            --git)
                GREP_PROG='git grep'
                ;;
            --)
                NO_MORE_FLAGS=1
                ;;
            *)
                ARGS+=("$(smartquote "$ARG")")
                # Our options need to be first; start ignoring flags
                NO_MORE_FLAGS=1
                ;;
        esac
    else
        ARGS+=("$(smartquote "$ARG")")
    fi
done

VIM_ARGS=()

if [[ -n $GREP_PROG ]]; then
    VIM_ARGS+=(-c "set grepprg=${GREP_PROG// /\\ }")
fi

VIM_ARGS+=(
    # Open vim with `:grep' results
    -c "$(escape_vimcmd "grep ${ARGS[*]}")"
    -c 'cw'
)

exec vim \
    "${VIM_ARGS[@]}"
