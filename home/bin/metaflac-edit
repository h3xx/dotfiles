#!/bin/bash
# vi: et sts=4 sw=4 ts=4

shopt -s inherit_errexit &>/dev/null
set -e

TEMP_DIR=$(mktemp -d -t "${0##*/}.XXXXXX")
cleanup() {
    rm -fr -- "$TEMP_DIR"
}
trap 'cleanup' EXIT

edit_flac() {
    TAGS_TEMP=$(mktemp -p "$TEMP_DIR" -t 'tags.XXXXXX')
    TAGS_ORIG=$(mktemp -p "$TEMP_DIR" -t '.tags-orig.XXXXXX')
    metaflac --export-tags-to="$TAGS_TEMP" "$1"
    cp -- "$TAGS_TEMP" "$TAGS_ORIG"
    ${EDITOR:-vi} "$TAGS_TEMP"
    if diff -q "$TAGS_TEMP" "$TAGS_ORIG" &>/dev/null; then
        printf 'Tags not modified, skipping...\n' >&2
    else
        metaflac --remove-all-tags --import-tags-from="$TAGS_TEMP" "$1"
    fi
}

edit_ogg() {
    TAGS_TEMP=$(mktemp -p "$TEMP_DIR" -t 'tags.XXXXXX')
    TAGS_ORIG=$(mktemp -p "$TEMP_DIR" -t '.tags-orig.XXXXXX')
    vorbiscomment --list "$1" >"$TAGS_TEMP"
    cp -- "$TAGS_TEMP" "$TAGS_ORIG"
    ${EDITOR:-vi} "$TAGS_TEMP"
    if diff -q "$TAGS_TEMP" "$TAGS_ORIG" &>/dev/null; then
        printf 'Tags not modified, skipping...\n' >&2
    else
        vorbiscomment --write --commentfile "$TAGS_TEMP" "$1"
    fi
}

# prints out the simple mimetype (e.g. `image/jpeg') of a file's contents
get_mimetype() {
    file \
        --dereference \
        --brief \
        --mime-type \
        -- \
        "$@" \
        2>/dev/null
}

for FN; do
    MIMETYPE=$(get_mimetype "$FN")
    case "$MIMETYPE" in
        'audio/flac'|'audio/x-flac')
            edit_flac "$FN"
            ;;
        'audio/ogg')
            edit_ogg "$FN"
            ;;
        *)
            printf '%s: Unrecognized file format "%s"\n' \
                "$FN" \
                "$MIMETYPE" \
                >&2
            exit 2
            ;;
    esac
done
